name: Master Orchestrator - Fully Autonomous Agent

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write
  pages: write
  actions: write

jobs:
  orchestrate:
    # Only run when issue has 'research' label
    if: contains(github.event.issue.labels.*.name, 'research')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Initialize Orchestrator
        run: |
          echo "ðŸš€ Master Orchestrator Started"
          echo "Issue: #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Triggering all workflows..."
      
      # Step 1: Auto-label the issue
      - name: Auto-label Issue
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python -c "
          from src.github_lifecycle import get_lifecycle_manager
          
          manager = get_lifecycle_manager()
          labels = manager.auto_label_issue(${{ github.event.issue.number }})
          print(f'âœ… Auto-labeled with: {labels}')
          "
      
      # Step 2: Run Research Agent
      - name: Execute Research Agent
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python src/main.py \
            --query "${{ github.event.issue.title }}" \
            --issue-body "${{ github.event.issue.body }}" \
            --repo "${{ github.repository }}" \
            --issue-number ${{ github.event.issue.number }} \
            --output-dir ./outputs
      
      # Step 3: Upload Artifacts
      - name: Upload Research Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: research-report-${{ github.event.issue.number }}
          path: outputs/
          retention-days: 90
      
      # Step 4: Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./outputs
          destination_dir: research-${{ github.event.issue.number }}
          enable_jekyll: false
      
      # Step 5: Post Results to Issue
      - name: Post Comprehensive Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read outputs if they exist
            let summary = '## ðŸŽ¯ Research Complete\n\n';
            
            try {
              // Check if markdown report exists
              if (fs.existsSync('./outputs/report.md')) {
                const report = fs.readFileSync('./outputs/report.md', 'utf8');
                summary += report;
              }
              
              // Add dashboard link
              summary += `\n\nðŸ“Š **Interactive Dashboard**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/research-${{ github.event.issue.number }}/\n\n`;
              
              // Add artifacts link
              summary += `ðŸ“¦ **Download Artifacts**: Available in the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\n`;
              
              // Add quality metrics if available
              if (fs.existsSync('./outputs/evaluation.json')) {
                const evaluation = JSON.parse(fs.readFileSync('./outputs/evaluation.json', 'utf8'));
                summary += `## ðŸ“ˆ Quality Metrics\n\n`;
                summary += `- **Overall Score**: ${evaluation.overall_score}/1.0\n`;
                summary += `- **Rating**: ${evaluation.rating}\n`;
                summary += `- **Comprehensiveness**: ${evaluation.scores.comprehensiveness}/1.0\n`;
                summary += `- **Relevance**: ${evaluation.scores.relevance}/1.0\n`;
              }
              
              // Add observability metrics if available
              if (fs.existsSync('./outputs/metrics.json')) {
                const metrics = JSON.parse(fs.readFileSync('./outputs/metrics.json', 'utf8'));
                summary += `\n## âš¡ Performance Metrics\n\n`;
                summary += `- **Total Duration**: ${metrics.total_duration}s\n`;
                summary += `- **Data Sources**: ${metrics.sources_count}\n`;
                summary += `- **Items Found**: ${metrics.items_count}\n`;
              }
            } catch (error) {
              summary += `\nâš ï¸ Results processing: ${error.message}\n`;
            }
            
            summary += `\n---\n\nâœ¨ **Powered by Autonomous Research Agent** | [View Workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
      
      # Step 6: Lifecycle Management
      - name: Run Lifecycle Operations
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_PAT || secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          python -c "
          from src.github_lifecycle import get_lifecycle_manager
          
          manager = get_lifecycle_manager()
          
          # Enforce branch protections
          print('ðŸ”’ Enforcing branch protections...')
          manager.enforce_branch_protections()
          
          # Cleanup old branches
          print('ðŸ§¹ Cleaning up merged branches...')
          deleted = manager.cleanup_merged_branches()
          print(f'Deleted {len(deleted)} branches')
          
          # Auto-merge ready PRs
          print('ðŸ”„ Auto-merging ready PRs...')
          prs = manager.list_pull_requests()
          merged_count = 0
          for pr in prs:
              if manager.auto_merge_if_ready(pr['number']):
                  merged_count += 1
          print(f'Auto-merged {merged_count} PRs')
          
          print('âœ… Lifecycle operations complete')
          "
      
      # Step 7: Update Project Metrics
      - name: Update Project Metrics
        run: |
          echo "## ðŸ“Š Orchestrator Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… **All Workflows Executed Successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Completed Steps" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Auto-labeled issue" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Executed research agent" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Uploaded artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployed to GitHub Pages" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Posted results to issue" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Ran lifecycle management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Issue**: #${{ github.event.issue.number }}" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY
